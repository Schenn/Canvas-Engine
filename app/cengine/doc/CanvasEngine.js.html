<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: CanvasEngine.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: CanvasEngine.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author Steven Chennault &lt;schenn@gmail.com>
 */

/**
 * @namespace GeneralTypes
 */
/**
 * @typedef {Object.&lt;string, number>} GeneralTypes~coords
 * @property {number} x
 * @property {number} y

 */


(function(){
  /**
   * @type {boolean}
   * @default
   */
  var paused = true;

  /**
   * CanvasEngine contains the system.
   *
   * @namespace CanvasEngine
   *
   */
  var CanvasEngine = {
  };

  /**
   * Add a collection of entities from a json array.
   * @memberof CanvasEngine
   * @param {Array} screenMap initialization data for the entities to add.
   * @param {boolean} start Start animating after adding entities.
   */
  CanvasEngine.addMap = function(screenMap, start){
    // Convert to entity Array

    var entities = this.EntityManager.fromMap(screenMap);

    this.addEntities(entities, start);
  };

  /**
   * Add an array of Entities
   *    (Entity being a class derived from the entity base class)
   * @memberof CanvasEngine
   * @param {Array} entities The Entities to add, grouped by z-index
   * @param {boolean} start Start animating after adding entities
   *
   * @todo Change the expected sort structure of entities
   */
  CanvasEngine.addEntities = function(entities, start){
    $.each(entities, function(z){
      CanvasEngine.Screen.addZLayer(z);
    });

    this.EntityTracker.addEntities(entities);

    if(start){
      paused = false;
      this.Loop();
    }
  };

  /**
   * Run Forever
   * @memberof CanvasEngine
   *
   * @private
   */
  CanvasEngine.Loop = function(){
    var self = this;
    requestAnimationFrame(function(){
      self.Screen.drawScreen();
      self.Loop();
    });
  };

  /**
   * Draw through a z-index.
   *  Go through each entity in the current z-index and tell it to update.
   *  If it has a renderer component and that component is dirty,
   *    tell the renderer component to clear
   *    tell the renderer component to render
   *  Tell the entity to postRender
   *
   * @memberof CanvasEngine
   * @param {number} z The z index to draw
   * @param {jQuery#enhancedContext} ctx The EnhancedContext of a canvas
   */
  CanvasEngine.drawZ = function(z, ctx){
    if(!paused &amp;&amp; CanvasEngine.EntityTracker.entityCount() > 0) {
      setTimeout(function(){
        $.each(CanvasEngine.EntityTracker.getEntitiesByZ(z), function (index, entity) {
          if(CanvasEngine.utilities.exists(entity)){
            entity.broadcastToComponents("update");
            if(entity.getFromComponent("Renderer", "isDirty")){
              entity.messageToComponent("Renderer", "clear", ctx);
              entity.messageToComponent("Renderer", "render", ctx);
            }
            entity.broadcastToComponents("postRender");
          }
        });
      },1);
    }
  };

  /**
   * Clear all entities from the system
   * @memberof CanvasEngine
   */
  CanvasEngine.clearEntities = function(){
    //noinspection JSUnusedAssignment
    paused = true;
    CanvasEngine.EntityTracker.clearEntities();
    paused = false;
  };


  /**
   * Tell every entity under the current coords that the mouse is interacting with it.
   *
   * Called by the Screen when a mouse interacts with the stack.
   *
   * @param {GeneralTypes~coords} coords The click position
   * @param {string} interaction the type of mouse interaction
   * @param {GeneralTypes~coords} [previous] The Previous mouse position
   * @memberof CanvasEngine
   *
   */
  CanvasEngine.mouse = function(coords, interaction, previous){
    setTimeout(function(){
      var ents = CanvasEngine.positionsAtPixel(coords, 1, 1, "Mouse");
      $.each(ents, function(index, ent){
        switch(interaction){
          case "MouseMove":
            ent.broadcastToComponents("onMouseOver", coords);
            ent.broadcastToComponents("onMouseMove", coords);
            break;
          case "MouseDown":
            ent.broadcastToComponents("onMouseDown", coords);
            break;
          case "MouseUp":
            ent.broadcastToComponents("onMouseUp", coords);
            break;
          case "Click":
            ent.broadcastToComponents("Click", coords);
            break;
          default:
            console.log ("I don't know how to handle "+interaction);
            break;
        }

      });

    if(CanvasEngine.utilities.exists(previous) &amp;&amp; interaction === "MouseMove"){
      var last = CanvasEngine.positionsAtPixel(previous, 1, 1, "Mouse");
      // for each entity in last, if they are not in ents, then trigger onMouseOut
      $.each(last, function(index, lastEnt){
        if(!ents.includes(lastEnt)){
          lastEnt.broadcastToComponents("onMouseOut");
        }
      });
    }
    },1);
  };



  /**
   * Pause the game
   * @memberof CanvasEngine
   *
   * @param {boolean} forceIt
   */
  CanvasEngine.pause = function(forceIt){
    paused = (CanvasEngine.utilities.exists(forceIt)) ? forceIt : !paused;

    if(!paused){
      this.Loop();
    }
  };

  /**
   * Pause the engine on a right click.
   * @memberof CanvasEngine
   *
   */
  CanvasEngine.pauseOnRightClick = function(){
    this.pause(true);
  };

  /**
   * Unpause the engine
   * @memberof CanvasEngine
   */
  CanvasEngine.unPause = function(){
    $(document).off(".unpause");
    $(window).off(".unpause");

    this.pause(false);
  };

  /**
   * Is the engine currently paused?
   * @memberof CanvasEngine
   * @returns {boolean}
   */
  CanvasEngine.isPaused = function(){
    return paused;
  };

  /**
   * Get all the entities at a given pixel
   * @memberof CanvasEngine
   *
   * @param {GeneralTypes~coords} p pixel coordinate
   * @param {number} w width of search area
   * @param {number} h height of search area
   * @param {string} [hasComponent] Require entities to have a specific component.
   * @returns {Array} Entities at the specified position
   */
  CanvasEngine.positionsAtPixel = function(p, w, h, hasComponent){
    var zPixels =CanvasEngine.Screen.atPixel(p.x, p.y, h, w, true);
    if (zPixels.length > 0) {
      return CanvasEngine.EntityTracker.positionsAtPixel(p,w,h, Object.keys(zPixels), hasComponent);
    } else {
      return [];
    }
  };

  /**
   * Setup the canvas engine.
   *
   * @method
   * @param {jQuery | HTMLElement} canvas The canvas to base the engine off of
   *
   */
  CanvasEngine.setup = function(canvas){
    CanvasEngine.Screen.setScreen(canvas);
    $(document).on("contextmenu", function(){
      CanvasEngine.pauseOnRightClick();

      $(document).on("keypress.unpause", function(e){
        if(e.keyCode === 27){
          CanvasEngine.unPause();
        }
      });
      $(document).on("click.unpause", CanvasEngine.unPause);
      $(window).on("blur.unpause", CanvasEngine.unPause);

    });

  };

  window.CanvasEngine = CanvasEngine;
})();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Externals</h3><ul><li><a href="external-jQuery.html">jQuery</a></li></ul><h3>Classes</h3><ul><li><a href="Canvas.enhancedContext.html">enhancedContext</a></li><li><a href="CanvasEngine.Components.Image.html">Image</a></li><li><a href="CanvasEngine.Components.KeyPress.html">KeyPress</a></li><li><a href="CanvasEngine.Components.Mouse.html">Mouse</a></li><li><a href="CanvasEngine.Components.Movement.html">Movement</a></li><li><a href="CanvasEngine.Components.PointPlotter.html">PointPlotter</a></li><li><a href="CanvasEngine.Components.Renderer.html">Renderer</a></li><li><a href="CanvasEngine.Components.SpriteSheet.html">SpriteSheet</a></li><li><a href="CanvasEngine.Components.Text.html">Text</a></li><li><a href="CanvasEngine.Components.TileMap.html">TileMap</a></li><li><a href="CanvasEngine.Components.TileMap_TileClick.html">TileClick</a></li><li><a href="CanvasEngine.Components.Timer.html">Timer</a></li><li><a href="CanvasEngine.Entities.AnimatedSprite.html">AnimatedSprite</a></li><li><a href="CanvasEngine.Entities.Animator.html">Animator</a></li><li><a href="CanvasEngine.Entities.Button.html">Button</a></li><li><a href="CanvasEngine.Entities.Entity.html">Entity</a></li><li><a href="CanvasEngine.Entities.Image.html">Image</a></li><li><a href="CanvasEngine.Entities.Line.html">Line</a></li><li><a href="CanvasEngine.Entities.MobileSprite.html">MobileSprite</a></li><li><a href="CanvasEngine.Entities.Rect.html">Rect</a></li><li><a href="CanvasEngine.Entities.Sprite.html">Sprite</a></li><li><a href="CanvasEngine.Entities.TileMap.html">TileMap</a></li><li><a href="CanvasEngine.Resources.SpriteSheet.html">SpriteSheet</a></li><li><a href="CanvasEngine.Screen.html">Screen</a></li><li><a href="CanvasEngine-EntityManager.html">EntityManager</a></li><li><a href="CanvasEngine-EntityManager.baseEntity.html">baseEntity</a></li><li><a href="CanvasEngine-EntityTracker.html">EntityTracker</a></li><li><a href="CanvasEngine-resourceManager.html">resourceManager</a></li></ul><h3>Events</h3><ul><li><a href="keyboard.html#event:keypress">keypress</a></li></ul><h3>Namespaces</h3><ul><li><a href="Callbacks.html">Callbacks</a></li><li><a href="Canvas.html">Canvas</a></li><li><a href="CanvasEngine.html">CanvasEngine</a></li><li><a href="CanvasEngine.Components.html">Components</a></li><li><a href="CanvasEngine.Entities.html">Entities</a></li><li><a href="CanvasEngine.Properties.html">Properties</a></li><li><a href="CanvasEngine.Resources.html">Resources</a></li><li><a href="CanvasEngine%250A%250AA%2520collection%2520of%2520utility%2520functions.utilities.html">utilities</a></li><li><a href="external-jQuery.fn.html">fn</a></li><li><a href="GeneralTypes.html">GeneralTypes</a></li><li><a href="keyboard.html">keyboard</a></li><li><a href="LocalParams.html">LocalParams</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Jun 02 2016 00:41:14 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
